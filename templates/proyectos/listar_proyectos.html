{% load dict_filters %}
{% if proyectos %}
<div class="container mt-4">
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for proyecto in proyectos %}
        <div class="col">
        {% if forloop.last %}
        <div class="card h-100 shadow-sm" hx-trigger="revealed">
        {% else %}
        <div class="card h-100 shadow-sm">
        {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ proyecto.title }}</h5>
            <p class="card-text">{{ proyecto.description|truncatewords:25 }}</p>
            <p class="card-text"><small class="text-muted">Ubicación: {{ proyecto.location }}</small></p>
            <p class="card-text"><small class="text-muted">Fecha de inicio: {{ proyecto.start_date|date:"M d" }}</small></p>
            <p class="card-text"><small class="text-muted">Fecha de fin: {{ proyecto.end_date }}</small></p>
            <p class="card-text"><small class="text-muted">Estado: {{ proyecto.status }}</small></p>

            {% if user.is_authenticated %}
              {% if user.role == 'organizacion' %}
                <a href="{% url 'editar_proyecto' proyecto.id %}" class="btn btn-outline-primary btn-sm">Editar</a>
                <a href="{% url 'listar_postulaciones' proyecto.id %}" class="btn btn-outline-secondary btn-sm">Ver postulaciones</a>
                {% if proyecto.status == 'activo' %}
                  <a href="{% url 'cerrar_proyecto' proyecto.id %}" class="btn btn-outline-danger btn-sm">Cerrar</a>
                {% elif proyecto.status == 'cerrado' or proyecto.status == 'finalizado' or proyecto.status == 'cancelado' %}
                  <a href="{% url 'reactivar_proyecto' proyecto.id %}" class="btn btn-outline-success btn-sm">Reactivar</a>
                {% endif %}
              {% elif user.role == 'voluntario' and proyecto.status == 'activo' %}
                {% with postulacion=postulaciones_por_proyecto|dict_get:proyecto.id %}
                  {% if postulacion %}
                    {% if postulacion.status == 'pendiente' %}
                      <a href="{% url 'editar_postulacion' postulacion.id %}" class="btn btn-warning btn-sm">Editar postulación</a>
                      <a href="{% url 'cancelar_postulacion' postulacion.id %}" class="btn btn-outline-danger btn-sm">Cancelar</a>
                    {% elif postulacion.status == 'aceptada' %}
                      <span class="badge bg-success">Postulación aprobada</span>
                    {% elif postulacion.status == 'rechazada' %}
                      <span class="badge bg-danger">Postulación rechazada</span>
                    {% endif %}
                  {% else %}
                    <a href="{% url 'crear_postulacion' proyecto.id %}" class="btn btn-primary btn-sm">Postularse</a>
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-outline-info btn-sm">Inicia sesión para postularte</a>
            {% endif %}

            <a href="{% url 'detalle_proyecto' proyecto.id %}" class="btn btn-link btn-sm">Ver detalles</a>
          </div>
        </div>
      </div>
        {% endfor %}
    </div>
</div>
{% else %}
<p>No hay proyectos disponibles.</p>
{% endif %}