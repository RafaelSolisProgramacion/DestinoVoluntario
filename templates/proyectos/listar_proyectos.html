{% load dict_filters %}
{% if proyectos %}
        {% for proyecto in proyectos %}
        <div class="col">
        {% if forloop.last and proyectos.has_next %}
        <div class="card h-100 shadow-sm" 
          hx-trigger="revealed" 
          hx-get="{{ pagination_url }}?page={{ proyectos.number|add:1 }}" 
          hx-target="#proyectos-grid" 
        <div class="card h-100 shadow-lg border-0 p-2" style="border-radius: 20px;">
        {% else %}
        <div class="card h-100 shadow-sm">
        {% endif %}
          <div class="card-body">
            <h5 class="card-title">{{ proyecto.title }}</h5>
            <p class="card-text">{{ proyecto.description|truncatewords:25 }}</p>
            <p class="card-text"><small class="text-muted">Ubicación: {{ proyecto.location }}</small></p>
            <div style="position:relative;">
              {% if proyecto.image %}
                <img src="{{ proyecto.image.url }}" alt="Imagen del proyecto" class="w-100 mb-3" style="height: 220px; object-fit: cover; border-radius: 18px;">
              {% else %}
                <img src="/static/images/ocean.jpg" alt="Imagen del proyecto" class="w-100 mb-3" style="height: 220px; object-fit: cover; border-radius: 18px;">
              {% endif %}
            </div>
            <div class="card-body p-0">
              <h3 class="fw-bold mb-0">{{ proyecto.title }}</h3>
              <p class="text-secondary mb-3" style="font-size:1.1rem;">{{ proyecto.description }}</p>
              <div class="d-flex flex-wrap gap-4 mb-3">
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-calendar-event text-secondary"></i>
                  <span class="fw-semibold">Fecha de Inicio:</span>
                  <span class="fw-bold text-success">{{ proyecto.start_date|date:"d/m/Y" }}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-calendar-x text-secondary"></i>
                  <span class="fw-semibold">Fecha de Finalización:</span>
                  <span class="fw-bold text-danger">{{ proyecto.end_date|date:"d/m/Y" }}</span>
                </div>
                <div class="d-flex align-items-center gap-2">
                  <i class="bi bi-geo-alt text-secondary"></i>
                  <span class="fw-semibold">Ubicación:</span>
                  <a href="#" class="fw-bold text-primary text-decoration-none">{{ proyecto.location }}</a>
                </div>
              </div>
              <div class="mb-3">
                <span class="fw-semibold">Estado actual:</span>
                {% if proyecto.status == 'activo' %}
                  <span class="badge bg-success">Activo</span>
                {% else %}
                  <span class="badge bg-secondary">Inactivo</span>
                {% endif %}
              </div>
              {% if user.is_authenticated and user.role == 'organizacion' %}
                <form method="post" action="{% url 'cambiar_estado_proyecto' proyecto.id %}" class="d-inline">
                  {% csrf_token %}
                  {% if proyecto.status == 'activo' %}
                    <button type="submit" name="estado" value="inactivo" class="btn btn-outline-danger btn-sm">Marcar como inactivo</button>
                  {% else %}
                    <button type="submit" name="estado" value="activo" class="btn btn-outline-success btn-sm">Marcar como activo</button>
                  {% endif %}
                </form>
              {% endif %}
              <div class="d-flex gap-2 mt-2">
                <a href="#" class="btn btn-outline-secondary flex-fill">Cancelar</a>
                <a href="{% url 'detalle_proyecto' proyecto.id %}" class="btn btn-primary flex-fill">Ver Detalles</a>
              </div>
            </div>
            <p class="card-text"><small class="text-muted">Fecha de inicio: {{ proyecto.start_date|date:"M d" }}</small></p>
            <p class="card-text"><small class="text-muted">Fecha de fin: {{ proyecto.end_date }}</small></p>
            <p class="card-text"><small class="text-muted">Estado: {{ proyecto.status }}</small></p>

            {% if user.is_authenticated %}
              {% if user.role == 'organizacion' %}
                <a href="{% url 'editar_proyecto' proyecto.id %}" class="btn btn-outline-primary btn-sm">Editar</a>
                <a href="{% url 'listar_postulaciones' proyecto.id %}" class="btn btn-outline-secondary btn-sm">Ver postulaciones</a>
                  {% if proyecto.status == 'activo' %}
                    <span class="badge bg-success px-4 py-2" style="font-size:1.1rem; background-color:#d4fbe6; color:#1e9c53; border-radius: 12px; font-weight: 600;">Activo</span>
                    <a href="{% url 'cerrar_proyecto' proyecto.id %}" class="btn btn-outline-danger btn-sm">Cerrar</a>
                  {% elif proyecto.status == 'cerrado' %}
                    <span class="badge bg-danger px-3 py-2" style="font-size:1rem;">Cerrado</span>
                    <a href="{% url 'reactivar_proyecto' proyecto.id %}" class="btn btn-outline-success btn-sm">Reactivar</a>
                  {% elif proyecto.status == 'finalizado' %}
                    <span class="badge bg-secondary px-3 py-2" style="font-size:1rem;">Finalizado</span>
                  {% elif proyecto.status == 'cancelado' %}
                    <span class="badge bg-warning px-3 py-2" style="font-size:1rem;">Cancelado</span>
                  {% endif %}
              {% elif user.role == 'voluntario' and proyecto.status == 'activo' %}
                {% with postulacion=postulaciones_por_proyecto|dict_get:proyecto.id %}
                  {% if postulacion %}
                    {% if postulacion.status == 'pendiente' %}
                  <div class="card h-100 shadow-lg border-0 p-2" style="border-radius: 20px;">
                      <a href="{% url 'cancelar_postulacion' postulacion.id %}" class="btn btn-outline-danger btn-sm">Cancelar</a>
                    {% elif postulacion.status == 'aceptada' %}
                      <span class="badge bg-success">Postulación aprobada</span>
                    {% elif postulacion.status == 'rechazada' %}
                      <span class="badge bg-danger">Postulación rechazada</span>
                    {% endif %}
                  {% else %}
                    <a href="{% url 'crear_postulacion' proyecto.id %}" class="btn btn-primary btn-sm">Postularse</a>
                  {% endif %}
                {% endwith %}
              {% endif %}
            {% else %}
              <a href="{% url 'login' %}" class="btn btn-outline-info btn-sm">Inicia sesión para postularte</a>
            {% endif %}

            <a href="{% url 'detalle_proyecto' proyecto.id %}" class="btn btn-link btn-sm">Ver detalles</a>
          </div>
        </div>
      </div>
        {% endfor %}
{% else %}
<p>No hay proyectos disponibles.</p>
{% endif %}